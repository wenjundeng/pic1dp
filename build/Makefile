# Copyright 2012 Wenjun Deng <wdeng@wdeng.info>
#
# This file is part of PIC1D-PETSc
#
# PIC1D-PETSc is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PIC1D-PETSc is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PIC1D-PETSc.  If not, see <http://www.gnu.org/licenses/>.


# Makefile for compiling PIC1D-PETSc
#
# MPI Fortran 90 compiler
ifndef MPIF90
	MPIF90 := mpif90
endif

# compiling options
ifndef FFLAGS
#	FFLAGS := -g -fbounds-check -ffpe-trap=invalid,zero,overflow # for debugging
	FFLAGS := -O2
endif

# source file path
SRCDIR := ../src

# module object files
MODOBJ := pic1dp_global.o pic1dp_input.o pic1dp_particle.o \
 pic1dp_field.o pic1dp_interaction.o pic1dp_output.o wtimer.o gaussian.o

.PHONY : build clean

build : pic1dp

# PETSc variables
-include $(PETSC_DIR)/conf/variables

# first layer dependency files .d1
-include $(MODOBJ:.o=.d1)

# use GNU tools to build module dependency files .d1
# each .d1 file gives rules to generate corresponding .d2 file
# .d2 files are generated by Fortran compiler with -MM option
# corresponding .mod files are generated when compiler generates .d2 files
$(MODOBJ:.o=.d1) : %.d1 : $(SRCDIR)/%.F90
	@echo 'making $@...'
	@echo '-include $(@:.d1=.d2)' > $@
	@exec echo -n '$(@:.d1=.d2) : $< ' >> $@
	@exec sed -n 's/^[ \t]*use \([^ \t,]*\).*$$/\1.mod/p' $< | sort | uniq | paste -s --delimiters=" " >> $@
	@exec echo -e '\t$$(MPIF90) $(FFLAGS) -MM $$< $$(FCPPFLAGS) > $$@' >> $@
	@echo 'finished making $@'

# compile main program and link all modules
pic1dp : $(SRCDIR)/pic1dp.F90 $(MODOBJ)
	$(MPIF90) $(FFLAGS) -o $@ $^ $(FCPPFLAGS) $(PETSC_LIB)

# compile modules
$(MODOBJ) : %.o : $(SRCDIR)/%.F90 %.d2
	$(MPIF90) $(FFLAGS) -D__PETSc -c -o $@ $< $(FCPPFLAGS)

clean :
	rm -f pic1dp *.o *.mod *.d1 *.d2

